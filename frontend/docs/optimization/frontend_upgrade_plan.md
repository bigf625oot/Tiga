# Frontend "Task Space" Upgrade Plan

## 1. Overview
This document outlines the upgrade plan for the Frontend "Task Space" to align with the backend's "Advanced Distributed Multi-Agent System" architecture. The goal is to provide a seamless, high-performance, and secure user experience for managing complex agent tasks.

## 2. Core Modules Upgrade

### 2.1 Agent Task Execution Engine (智能体任务执行引擎)
**Current State**: Basic list/tree view in `TaskPanel.vue` and `TaskTree.vue`.
**Target State**:
- **DAG Visualization**: Use `VueFlow` or `Mermaid` to visualize task dependencies dynamically.
- **Real-time Status**: Fully integrate SSE events for sub-second status updates (Pending -> Running -> Completed).
- **Interactive Control**: Allow pausing/resuming specific sub-tasks (if backend supports).
- **Detailed Logs**: structured logs with fold/unfold for each step.

**Implementation Details**:
- Update `TaskTree.vue` to support recursive DAG rendering.
- Enhance `workflow.store.ts` to handle `agent_task_update` SSE events with payload `{ taskId, status, progress, logs }`.
- Add `TaskDetail.vue` side drawer for inspecting input/output data of each task.

### 2.2 Code Runtime Environment (代码运行环境)
**Current State**: Read-only `ArtifactEditor.vue`.
**Target State**:
- **Interactive Editor**: Monaco Editor with syntax highlighting and basic autocomplete.
- **Version Control**: UI to show diffs between code versions generated by the agent.
- **Execution Feedback**: Inline markers for runtime errors (red squiggles) based on backend feedback.

**Implementation Details**:
- Upgrade `ArtifactEditor` to use `monaco-editor-vue3`.
- Add "Run Selection" button to send specific code blocks to Sandbox API.
- Implement `CodeVersionHistory` component.

### 2.3 Sandbox Isolation Mechanism (沙箱隔离机制)
**Current State**: Basic `SandboxResultViewer`.
**Target State**:
- **Resource Monitor**: Real-time graphs for CPU/RAM usage (using E2B metrics).
- **File Manager**: Explorer-like UI to browse/upload/download sandbox files.
- **Process List**: View running processes in the sandbox.

**Implementation Details**:
- Create `SandboxResourceManager.vue` using `v-chart` or `chart.js`.
- Create `SandboxFileManager.vue` with tree view and drag-drop upload.
- Integrate `SandboxService` to poll resource usage or receive via SSE.

### 2.4 Terminal Interaction System (终端交互系统)
**Current State**: `SandboxTerminal.vue` using `xterm.js`.
**Target State**:
- **Streaming Support**: Ensure WebSocket/SSE integration for real-time shell output.
- **Resize Handling**: Sync terminal size with backend PTY.
- **Security Feedback**: Visual indicators when a command is blocked by the whitelist (e.g., Red flash/Toast).

**Implementation Details**:
- Refactor `SandboxTerminal.vue` to use a dedicated WebSocket connection for lower latency.
- Add `fitAddon` logic to send resize events to backend.
- Handle "Command Blocked" error messages specifically.

## 3. Technical Architecture

### 3.1 State Management (Pinia)
- **Store**: `useWorkflowStore`
- **Actions**:
    - `connectTaskStream(sessionId)`: Establishes SSE connection.
    - `executeCommand(cmd)`: Sends terminal command.
    - `fetchSandboxResources()`: Polling or WS subscription.

### 3.2 API Layer
- **Client**: Axios for REST, native `EventSource` for SSE.
- **Endpoints**:
    - `POST /api/v2/agent/tasks/{id}/control`: Pause/Resume.
    - `GET /api/v2/sandbox/{id}/files`: List files.
    - `WS /api/v2/sandbox/{id}/terminal`: Terminal stream.

## 4. UX/UI Improvements
- **Dark Mode**: Ensure all new components support the app's theme.
- **Loading States**: Skeleton screens for initial data load.
- **Error Handling**: Graceful degradation (e.g., if Sandbox is offline, show "Reconnecting..." instead of blank).

## 5. Security
- **Input Sanitization**: Client-side validation for terminal input (though backend is authority).
- **Sensitive Data**: Mask secrets in logs/code view.
